Multi-stage Dockerfiles are very important for DevOps, production optimization, and security hardening.

Letâ€™s cover:

1ï¸âƒ£ What is multi-stage build
2ï¸âƒ£ Why it is needed
3ï¸âƒ£ Basic syntax
4ï¸âƒ£ Python example (Django/FastAPI)
5ï¸âƒ£ Node example
6ï¸âƒ£ Golang example
7ï¸âƒ£ Security best practices
8ï¸âƒ£ Interview questions

ğŸ”¹ 1ï¸âƒ£ What is Multi-Stage Docker Build?

Multi-stage build allows you to use multiple FROM statements in one Dockerfile.

You build in one stage â†’ copy only required artifacts â†’ final image is minimal.

Introduced in Docker 17.05.

ğŸ”¥ 2ï¸âƒ£ Why Multi-Stage Is Important?

Without multi-stage:

Build tools remain in final image

Larger image size

More vulnerabilities

Slower deployments

With multi-stage:

âœ” Smaller image
âœ” More secure
âœ” Faster pull time
âœ” Production-ready

ğŸ”¹ 3ï¸âƒ£ Basic Syntax
# Stage 1 - Build
FROM python:3.11 AS builder

WORKDIR /app
COPY requirements.txt .
RUN pip install --user -r requirements.txt

# Stage 2 - Runtime
FROM python:3.11-slim

WORKDIR /app
COPY --from=builder /root/.local /root/.local
COPY . .

CMD ["python", "app.py"]


--from=builder copies only required files.

ğŸ”¥ 4ï¸âƒ£ Real Python Example (FastAPI)

Assume you are building FastAPI app.

âŒ Without Multi-Stage
FROM python:3.11

WORKDIR /app
COPY . .
RUN pip install -r requirements.txt

CMD ["uvicorn", "main:app"]


Image size ~900MB

âœ… With Multi-Stage
# Stage 1 - Builder
FROM python:3.11 AS builder

WORKDIR /install
COPY requirements.txt .
RUN pip install --prefix=/install -r requirements.txt

# Stage 2 - Runtime
FROM python:3.11-slim

WORKDIR /app
COPY --from=builder /install /usr/local
COPY . .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]


Image size reduces significantly ğŸ”¥

ğŸ”¥ 5ï¸âƒ£ NodeJS Example
# Build stage
FROM node:18 AS builder

WORKDIR /app
COPY package*.json .
RUN npm install
COPY . .
RUN npm run build

# Runtime stage
FROM node:18-alpine

WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules

CMD ["node", "dist/index.js"]


âœ” Build tools removed
âœ” Smaller image

ğŸ”¥ 6ï¸âƒ£ Golang Example (Best Use Case)

Go is perfect for multi-stage.

# Build stage
FROM golang:1.22 AS builder

WORKDIR /app
COPY go.mod .
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o app

# Final stage
FROM alpine:3.19

WORKDIR /app
COPY --from=builder /app/app .

CMD ["./app"]


Final image ~10MB ğŸ”¥

ğŸ” 7ï¸âƒ£ Security Benefits

Multi-stage helps:

âœ” Remove compilers
âœ” Remove build dependencies
âœ” Reduce attack surface
âœ” Fewer CVEs (important for Trivy scanning)

If you scan:

Trivy

Multi-stage image â†’ fewer vulnerabilities.

ğŸ”¹ 8ï¸âƒ£ Advanced Example (Django Production)
# Stage 1 - Build wheels
FROM python:3.11 AS builder

WORKDIR /app
RUN apt-get update && apt-get install -y build-essential

COPY requirements.txt .
RUN pip wheel --no-cache-dir --no-deps --wheel-dir /app/wheels -r requirements.txt

# Stage 2 - Runtime
FROM python:3.11-slim

WORKDIR /app

COPY --from=builder /app/wheels /wheels
RUN pip install --no-cache /wheels/*

COPY . .

CMD ["gunicorn", "project.wsgi:application", "--bind", "0.0.0.0:8000"]


âœ” Build tools not present in final image
âœ” Production-ready

ğŸ”¥ 9ï¸âƒ£ How To Name Stages
FROM python:3.11 AS builder
FROM python:3.11-slim AS runtime


Then:

COPY --from=builder ...

ğŸ”¹ 1ï¸âƒ£0ï¸âƒ£ Target Specific Stage

Build only builder stage:

docker build --target builder -t myimage .


Useful for debugging.

ğŸ”¥ 1ï¸âƒ£1ï¸âƒ£ Production DevOps Flow

You:

1ï¸âƒ£ Write multi-stage Dockerfile
2ï¸âƒ£ Build image
3ï¸âƒ£ Scan with Trivy
4ï¸âƒ£ Push to ECR
5ï¸âƒ£ Deploy to Kubernetes

Smaller image = faster pod startup in Kubernetes.

ğŸ”¥ 1ï¸âƒ£2ï¸âƒ£ Interview Questions
Q1: Why use multi-stage?

To reduce image size and attack surface.

Q2: Difference between alpine and slim?

alpine â†’ very small, musl libc

slim â†’ Debian-based minimal

Q3: Does multi-stage improve security?

Yes. Removes compilers and dev dependencies.

Q4: Can we have more than 2 stages?

Yes. Unlimited stages.

ğŸš€ Final Summary
Without Multi-Stage	With Multi-Stage
Large image	Small image
More CVEs	Fewer CVEs
Slower pull	Faster pull
Less secure	More secure
